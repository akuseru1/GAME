<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ãƒ¯ãƒ¼ãƒ‰ãƒ—ãƒ­ã‚»ãƒƒã‚µ</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f0f0f0;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      min-height: 100vh;
      box-shadow: 0 0 20px rgba(0,0,0,0.1);
    }

    .toolbar {
      background: #2b579a;
      padding: 10px 20px;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
    }

    .toolbar button, .toolbar select {
      padding: 8px 15px;
      border: none;
      background: white;
      cursor: pointer;
      border-radius: 4px;
      font-size: 14px;
      transition: background 0.2s;
    }

    .toolbar button:hover {
      background: #e0e0e0;
    }

    .toolbar button.active {
      background: #4a90e2;
      color: white;
    }

    .separator {
      width: 1px;
      height: 25px;
      background: rgba(255,255,255,0.3);
    }

    .editor {
      min-height: 500px;
      padding: 40px 60px;
      outline: none;
      font-size: 16px;
      line-height: 1.6;
    }

    .status-bar {
      background: #f8f8f8;
      padding: 8px 20px;
      border-top: 1px solid #ddd;
      font-size: 12px;
      color: #666;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .save-status {
      color: #4a90e2;
      font-weight: 500;
    }

    .save-status.saving {
      color: #ff9800;
    }

    input[type="color"] {
      width: 40px;
      height: 30px;
      border: none;
      cursor: pointer;
      border-radius: 4px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="toolbar">
      <select id="fontSelect">
        <option value="'Segoe UI', sans-serif">Segoe UI</option>
        <option value="Arial, sans-serif">Arial</option>
        <option value="'Times New Roman', serif">Times New Roman</option>
        <option value="'Courier New', monospace">Courier New</option>
        <option value="Georgia, serif">Georgia</option>
        <option value="Verdana, sans-serif">Verdana</option>
      </select>

      <select id="fontSize">
        <option value="12px">12</option>
        <option value="14px">14</option>
        <option value="16px" selected>16</option>
        <option value="18px">18</option>
        <option value="20px">20</option>
        <option value="24px">24</option>
        <option value="32px">32</option>
      </select>

      <div class="separator"></div>

      <button onclick="format('bold')" title="å¤ªå­—"><b>B</b></button>
      <button onclick="format('italic')" title="æ–œä½“"><i>I</i></button>
      <button onclick="format('underline')" title="ä¸‹ç·š"><u>U</u></button>
      <button onclick="format('strikeThrough')" title="å–ã‚Šæ¶ˆã—ç·š"><s>S</s></button>

      <div class="separator"></div>

      <input type="color" id="textColor" value="#000000" title="æ–‡å­—è‰²">
      <input type="color" id="bgColor" value="#ffffff" title="èƒŒæ™¯è‰²">

      <div class="separator"></div>

      <button onclick="format('justifyLeft')" title="å·¦æƒãˆ">â‰¡</button>
      <button onclick="format('justifyCenter')" title="ä¸­å¤®æƒãˆ">â‰¡</button>
      <button onclick="format('justifyRight')" title="å³æƒãˆ">â‰¡</button>

      <div class="separator"></div>

      <button onclick="format('insertUnorderedList')" title="ç®‡æ¡æ›¸ã">â€¢ ãƒªã‚¹ãƒˆ</button>
      <button onclick="format('insertOrderedList')" title="ç•ªå·ä»˜ããƒªã‚¹ãƒˆ">1. ãƒªã‚¹ãƒˆ</button>

      <div class="separator"></div>

      <button onclick="clearFormat()" title="æ›¸å¼ã‚¯ãƒªã‚¢">âœ• æ›¸å¼ã‚¯ãƒªã‚¢</button>
      <button onclick="downloadDoc()" title="ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰">ğŸ’¾ ä¿å­˜</button>
      <button onclick="printDoc()" title="å°åˆ·">ğŸ–¨ å°åˆ·</button>
      <button onclick="clearDoc()" title="æ–°è¦ä½œæˆ">ğŸ“„ æ–°è¦</button>
    </div>

    <div id="editor" class="editor" contenteditable="true">
      <p>ã“ã“ã«æ–‡ç« ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„...</p>
    </div>

    <div class="status-bar">
      <span id="wordCount">æ–‡å­—æ•°: 0 | å˜èªæ•°: 0</span>
      <span id="saveStatus" class="save-status">è‡ªå‹•ä¿å­˜æ¸ˆã¿</span>
    </div>
  </div>

  <script>
    const editor = document.getElementById('editor');
    const fontSelect = document.getElementById('fontSelect');
    const fontSize = document.getElementById('fontSize');
    const textColor = document.getElementById('textColor');
    const bgColor = document.getElementById('bgColor');
    const saveStatus = document.getElementById('saveStatus');

    let autoSaveTimer = null;
    let isInitialLoad = true;

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒ
    async function loadSavedContent() {
      try {
        const result = await window.storage.get('wordprocessor_content');
        if (result && result.value) {
          const data = JSON.parse(result.value);
          editor.innerHTML = data.content;
          saveStatus.textContent = 'å‰å›ã®å†…å®¹ã‚’å¾©å…ƒã—ã¾ã—ãŸ';
          setTimeout(() => {
            saveStatus.textContent = 'è‡ªå‹•ä¿å­˜æ¸ˆã¿';
          }, 2000);
        }
      } catch (error) {
        console.log('ä¿å­˜ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
      }
      isInitialLoad = false;
    }

    // è‡ªå‹•ä¿å­˜
    async function autoSave() {
      if (isInitialLoad) return;
      
      const content = editor.innerHTML;
      const data = {
        content: content,
        timestamp: new Date().toISOString()
      };

      try {
        saveStatus.textContent = 'ä¿å­˜ä¸­...';
        saveStatus.classList.add('saving');
        
        await window.storage.set('wordprocessor_content', JSON.stringify(data));
        
        saveStatus.textContent = 'è‡ªå‹•ä¿å­˜æ¸ˆã¿ (' + new Date().toLocaleTimeString() + ')';
        saveStatus.classList.remove('saving');
      } catch (error) {
        saveStatus.textContent = 'ä¿å­˜ã‚¨ãƒ©ãƒ¼';
        console.error('ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
      }
    }

    // å…¥åŠ›æ™‚ã«è‡ªå‹•ä¿å­˜ã‚’ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«
    function scheduleAutoSave() {
      if (autoSaveTimer) {
        clearTimeout(autoSaveTimer);
      }
      saveStatus.textContent = 'å…¥åŠ›ä¸­...';
      autoSaveTimer = setTimeout(autoSave, 1000);
    }

    function format(cmd, value = null) {
      document.execCommand(cmd, false, value);
      editor.focus();
    }

    fontSelect.addEventListener('change', () => {
      format('fontName', fontSelect.value);
    });

    fontSize.addEventListener('change', () => {
      format('fontSize', '7');
      const selection = window.getSelection();
      if (selection.rangeCount > 0) {
        const range = selection.getRangeAt(0);
        const span = document.createElement('span');
        span.style.fontSize = fontSize.value;
        range.surroundContents(span);
      }
    });

    textColor.addEventListener('change', () => {
      format('foreColor', textColor.value);
    });

    bgColor.addEventListener('change', () => {
      format('backColor', bgColor.value);
    });

    function clearFormat() {
      format('removeFormat');
      format('unlink');
    }

    function downloadDoc() {
      const content = editor.innerHTML;
      const blob = new Blob([content], { type: 'text/html' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'document.html';
      a.click();
      URL.revokeObjectURL(url);
    }

    function printDoc() {
      window.print();
    }

    async function clearDoc() {
      if (confirm('æ–°è¦ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ä½œæˆã—ã¾ã™ã‹ï¼Ÿç¾åœ¨ã®å†…å®¹ã¯è‡ªå‹•ä¿å­˜ã•ã‚Œã¦ã„ã¾ã™ã€‚')) {
        editor.innerHTML = '<p>ã“ã“ã«æ–‡ç« ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„...</p>';
        isInitialLoad = true;
        await autoSave();
        isInitialLoad = false;
        updateWordCount();
      }
    }

    function updateWordCount() {
      const text = editor.innerText;
      const chars = text.length;
      const words = text.trim().split(/\s+/).filter(w => w.length > 0).length;
      document.getElementById('wordCount').textContent = `æ–‡å­—æ•°: ${chars} | å˜èªæ•°: ${words}`;
    }

    editor.addEventListener('input', () => {
      updateWordCount();
      scheduleAutoSave();
    });

    editor.addEventListener('click', () => {
      editor.focus();
      if (editor.innerText.trim() === 'ã“ã“ã«æ–‡ç« ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„...') {
        editor.innerHTML = '<p><br></p>';
      }
    });

    // ãƒšãƒ¼ã‚¸ã‚’é›¢ã‚Œã‚‹å‰ã«ä¿å­˜
    window.addEventListener('beforeunload', () => {
      if (autoSaveTimer) {
        clearTimeout(autoSaveTimer);
        autoSave();
      }
    });

    // åˆæœŸåŒ–
    loadSavedContent();
    updateWordCount();
  </script>
</body>
</html>